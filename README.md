# DoddLabMeID (Dodd Lab Metabolite Identification )
- Author: Zhiwei Zhou (zhouzw@stanford.edu)
- Created: 03/14/2023
- Last modified: 04/10/2023

## Introduction
This document is a part of DoddLabMetabolomics project. This part/package is aimed to steamlize the metabolite identification workflow for untargeted metabolomics projects. 

The **R** based workflow is developed by Zhiwei Zhou. Please feel free to reach out Zhiwei (zhouzw@stanford.edu) if you have any questions.

## Data Preparsion
- **Peak Table (required)**: A csv format table. If you use the **DoddMetabolomics workflow**, it usually generated by **xcms**.
    - 1st column: feature names. This column must be named as "name"
    - 2nd column: m/z. This column must be named as "mz"
    - 3rd column: rt. This column must be named as "rt"
    - other column: samples. Each column is one sample.
- **MS2 Files**: 
    - Support formats: mzML, mzXML, mgf, msp
    - The raw data converstion can be found from the tutorial


## Demo Data
The demo datasets is from IBD project. The raw data is acquired in **HILIC** column & **poisitive** mode.
- The **peak tables** contains 284 samples and 8338 features
- The **MS/MS files** are acquired for pool QC samples using data dependent acquisition (DDA). 

## Installation
The installation of required packages depends on the platform you use. This workflow is based on R, which requires installing some dependent packages first. 

##### Note: if you run in the Docker, all packages are well configured. Please go ahead to the Example Code part directly.

### R/RStudio
```
# intall public packages
if (!require(devtools)){
    install.packages("devtools")
}

if (!require(BiocManager)){
    install.packages("BiocManager")
}

# Required packages
required_pkgs <- c("dplyr","tidyr","readr", "stringr", "tibble", "purrr",
"ggplot2", "igraph", "pbapply", "Rdisop", "randomForest", "pryr", "BiocParallel", "magrittr", "rmarkdown", "caret")
BiocManager::install(required_pkgs)

devtools::install_github("ZhuMetLab/SpectraTools")
devtools::install_github("DoddLab/DoddLabDatabase")
devtools::install_github('DoddLab/DoddLabMetaboliteID')
```

### Docker
#### 1. Install the WSL & Docker desktop
https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-containers

#### 2. Load the `doddlabmetabolomics` images
Download the newest docker [image](https://drive.google.com/drive/folders/1EQmXRtd57-uywytf_J8d7GXtBfkO_rKX?usp=share_link) 
```
# load downloaded image
docker load --input .\doddlabmetabolomics_1.0.01.tar

# check the image whether installed
docker images
```

#### 3. Run docker container
```
# Run docker & open the 
# Note: please replace path with the working directory. In the demo code, the working directory is ~/Project/00_IBD_project/Data/20230327_raw_data_processing_test/DemoData

docker run --rm -ti -e PASSWORD="123456" -p 8787:8787 -e DISABLE_AUTH=true -v ~/Project/00_IBD_project/Data/20230327_raw_data_processing_test/DemoData:/home/rstudio/ doddlabmetabolomics:1.0.01
```

#### 4. Open broswer
- Open the RStudio server with http://localhost:8787/

![](https://raw.githubusercontent.com/JustinZZW/blogImg/main/202304101016826.png)

## Example Codes

### Using Dodd library only
```
# load required packages
library(tidyverse)
library(DoddLabDatabase)
library(DoddLabMetID)

# running for metabolite annotation
annotate_metabolite(ms1_file = 'Peak_Table.csv',
                    ms2_type = 'mzML',
                    path = '~/Project/00_IBD_project/Data/20230314_DoddMetID_demonstration/',
                    polarity = 'positive',
                    lib = 'dodd',
                    column = 'hilic',
                    ce = '20',
                    adduct_list = '[M+H]+',
                    mz_tol = 15,
                    mz_ppm_thr = 150,
                    pf_rt_range = 10,
                    tolerance_rt_range = 20,
                    is_rt_score = TRUE,
                    is_ms2_score = TRUE)
```

### Using Different Dodd libraries
```
# load required packages
library(tidyverse)
library(DoddLabDatabase)
library(DoddLabMetID)

# assign working directory
path <- '~/Project/00_IBD_project/Data/20230227_develop_metabolite_ID_workflow'

# Approach 1: Use dodd lib for annotation (m/z + RT + MS/MS match)
annotate_metabolite(ms1_file = 'Peak_Table.csv',
                    ms2_type = 'mzML',
                    path = path,
                    polarity = 'positive',
                    lib = 'dodd',
                    column = 'hilic',
                    ce = '20',
                    adduct_list = '[M+H]+',
                    mz_tol = 15,
                    mz_ppm_thr = 150,
                    pf_rt_range = 10,
                    tolerance_rt_range = 20,
                    is_rt_score = TRUE,
                    is_ms2_score = TRUE)

# rename the result folder in avoid to overlap
file.rename(from = file.path(path, '01_metabolite_annotation'),
            to = file.path(path, '01_metabolite_annotation_dodd_mz_rt_ms2'))

# Approach 2: Use dodd lib for annotation (m/z + RT)
annotate_metabolite(ms1_file = 'Peak_Table.csv',
                    ms2_type = 'mzML',
                    path = path,
                    polarity = 'positive',
                    lib = 'dodd',
                    column = 'hilic',
                    ce = '20',
                    adduct_list = '[M+H]+',
                    mz_tol = 15,
                    mz_ppm_thr = 150,
                    pf_rt_range = 10,
                    tolerance_rt_range = 20,
                    is_rt_score = FALSE,
                    is_ms2_score = TRUE)

# rename the result folder in avoid to overlap
file.rename(from = file.path(path, '01_metabolite_annotation'),
            to = file.path(path, '01_metabolite_annotation_dodd_mz_rt'))

# Approach 3: Use MS-DIAL lib for annotation (m/z + MS/MS)
annotate_metabolite(ms1_file = 'Peak_Table.csv',
                    ms2_type = 'mzML',
                    path = path,
                    polarity = 'positive',
                    lib = 'msdial',
                    mz_tol = 15,
                    mz_ppm_thr = 150,
                    dp_cutoff = 0.8,
                    direction = 'forward',
                    is_rt_score = FALSE,
                    is_ms2_score = TRUE)

# rename the result folder in avoid to overlap
file.rename(from = file.path(path, '01_metabolite_annotation'),
            to = file.path(path, '01_metabolite_annotation_msdial'))

# Merge them together, and assign the confidence level
merge_one_modes(path = path, 
                column = 'hilic',
                polarity = 'positive')
```


## Parameters

Here, it lists some **the most common parameters**. You can easily get detailed parameters in R using `?function_name`

- **ms1_file**: The name of ms1 peak table. Column 1 is "name", Column 2 is "mz" and column is "rt".
- **ms2_type**: MS2 
- **object**: If you using Tidymass workflow, you can use the mass_
- **path**: Path of working directory.
- **polarity**: Ionzation polarity. "positive" or "negative"
- **lib**: The library you want to use. "dodd" or "msdial"
- **column**: The column you used. "hilic" or "c18" 
- **ce**: Collision energy. "10", "20", "40"
- **adduct_list**: suggested "[M+H]+" and "[M-H]-" for positive and negative modes, respectively
- **mz_tol**: m/z tolerance. Default: 15 ppm
- **mz_ppm_thr**: m/z threshold. If the precursor m/z is less than this value, the absolute tolerance `mz_ppm_thr`*`mz_tol` would be applied. For example, mz_ppm_thr = 150 & mz_tol = 15, the tolerance `150*15*10^-6` would be applied for all features whose m/z <= 150. Default: 150 Dalton
- **pf_rt_range**: penlty-free RT range. Default: 10 s
- **tolerance_rt_range**: RT tolerance. Default: 20 s
- **is_rt_score**: Whether use RT for annotation? TRUE or FALSE. If applied, the RT disqualified candidates would be removed.
- **is_ms2_score**: Whether use MS/MS for annotation? TRUE or FALSE. If applied, the MS/MS disqualified candidates would be removed. 

## Results
### Using Dodd library only
Two files would be constructed in the working directory.
- `01_metabolite_annotation`: This folder contains all results and intermidate data for following analysis, and checking. This folder would be introduced in below:
- `ms2.msp`: all purified MS/MS spectra. It can be used for different tools, like GNPS, SIRIUS etc.


#### Files in the `01_metabolite_annotation` folder
- `00_intermediate_data`: a folder contains all intermediate data. Only used for debug.
- `02_experimental_ms2_spec_plot`: MS/MS plots. It will contain 2 pdf files. In default parametes, the only difference is the MS/MS score.
    - example
    ![](https://raw.githubusercontent.com/JustinZZW/blogImg/main/202304101057101.png)
- `annotation_summary.xlsx`: This is a summary table of metabolite annotation. 
    - each row is one metabolite/candidate, each column is the parameters related to this candidate
        - feature_name: feature name, named as MxxxTxxx
        - mz: m/z value
        - rt: retention time, in second
        - id: library identifier
        - name: compound name
        - formula: chemical formula
        - smiles: SMILES structure
        - inchikey: InChIKey identifier
        - adduct: adduct form
        - mz_lib: m/z value (theoretical value) in the library
        - rt_lib: RT value (standard RT) in the library
        - mz_error: the m/z difference between experimental measurement and theoretical value. Unit: ppm
        - rt_error: the RT difference between experimental measurement and standard value. Unit: second
        - rt_score: RT score with trapezoid scoring
        - msms_score_forward: MS/MS score (dot product score in forward)
        - msms_score_reverse: MS/MS score (dot product score in reverse)
        - mama_matched_frag: number of matched fragments
    - **Note:** If one feature have multiple candidates, it has been separated to different rows.


It usually looks like below:
![](https://raw.githubusercontent.com/JustinZZW/blogImg/main/202303151620670.png)


### Using Different Dodd libraries
- This function will integrate multiple annotation approach, and generate the final annotation table, like `annotation_table_merge_hilic_positive.xlsx`
- Most column is consistent to the Dodd library only
- Different columns are provided below:
    - with_ms2: whether have the MS2 spectrum. 1 (yes) or 0 (no)
    - column: used column 
    - polarity: use polarity
    - inchikey1: the first-layer inchikey (14 characters). It represent a annotation without stereoisomers
    - confidence:
        - level 1: mz + RT + MS2
        - level 2.1: mz + RT
        - level 2.2: mz + MS-DIAL MS2


## License
<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a> 
This work is licensed under the Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)
